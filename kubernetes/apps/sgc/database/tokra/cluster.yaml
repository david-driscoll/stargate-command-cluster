---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/refs/heads/main/mysql.oracle.com/innodbcluster_v2.json
apiVersion: mysql.oracle.com/v2
kind: InnoDBCluster
metadata:
  name: &app ${APP}
spec:
  instances: 2
  tlsUseSelfSigned: true
  router:
    instances: 1
    podSpec:
      resources:
        requests:
          cpu: 48m
          memory: 64M
  secretName: mycluster-cluster-secret
  backupProfiles:
    - name: dump
      dumpInstance:
        storage:
          s3:
            bucketName: ${APP}-dump
            config: ${APP}-backup-secret
            profile: default
            endpoint: http://minio.${INTERNAL_CLUSTER_SERVICE}:9000
    - name: snapshot
      snapshot:
        storage:
          s3:
            bucketName: ${APP}-snapshot
            config: ${APP}-backup-secret
            profile: default
            endpoint: http://minio.${INTERNAL_CLUSTER_SERVICE}:9000
  backupSchedules:
    - name: snapshot
      schedule: "0 4 * * *" # Daily at 4 AM
      backupProfileName: snapshot
    - name: dump
      schedule: "0 5 * * *" # Daily at 5 AM
      backupProfileName: dump
  datadirVolumeClaimTemplate:
    storageClass: longhorn
    accessMode: ReadWriteOnce
    size: 10Gi

  podSpec:
    resources:
      requests:
        cpu: 50m
        memory: 200Mi
      limits:
        cpu: 300m
        memory: 2Gi
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            podAffinityTerm:
              topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: *app
                  app.kubernetes.io/component: *app