---
# Weekly CronJob to prune unused container images on all Talos nodes
# Runs every Sunday at 2 AM to clean up unused images and free disk space
apiVersion: batch/v1
kind: CronJob
metadata:
  name: containerd-image-prune
  namespace: kube-system
spec:
  schedule: "0 2 * * 0" # Every Sunday at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: containerd-image-prune
        spec:
          hostNetwork: true
          hostPID: true
          restartPolicy: OnFailure
          containers:
          - name: prune
            image: debian:bookworm-slim@sha256:b4aa902587c2e61ce789849cb54c332b0400fe27b1ee33af4669e1f7e7c3e22f
            command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "=== Starting containerd image pruning on $(hostname) at $(date) ==="

              # Install required tools
              apt-get update -qq
              apt-get install -y -qq wget tar procps

              # Download and install crictl
              CRICTL_VERSION="v1.31.1"
              wget -q https://github.com/kubernetes-sigs/cri-tools/releases/download/${CRICTL_VERSION}/crictl-${CRICTL_VERSION}-linux-amd64.tar.gz -O /tmp/crictl.tar.gz
              tar -xzf /tmp/crictl.tar.gz -C /usr/local/bin/
              chmod +x /usr/local/bin/crictl
              rm /tmp/crictl.tar.gz

              # Configure containerd socket
              export CONTAINER_RUNTIME_ENDPOINT=unix:///host/run/containerd/containerd.sock
              export IMAGE_SERVICE_ENDPOINT=unix:///host/run/containerd/containerd.sock

              # Get baseline metrics
              echo "=== Before pruning ==="
              IMAGE_COUNT_BEFORE=$(crictl images -q | wc -l)
              SNAPSHOT_COUNT_BEFORE=$(ls /host/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots 2>/dev/null | wc -l || echo "0")
              echo "Images: $IMAGE_COUNT_BEFORE"
              echo "Snapshots: $SNAPSHOT_COUNT_BEFORE"

              # Prune unused images
              echo "=== Pruning unused images ==="
              crictl rmi --prune 2>&1 || echo "Prune completed with warnings (expected for in-use images)"

              # Get post-prune metrics
              echo "=== After pruning ==="
              IMAGE_COUNT_AFTER=$(crictl images -q | wc -l)
              SNAPSHOT_COUNT_AFTER=$(ls /host/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots 2>/dev/null | wc -l || echo "0")
              echo "Images: $IMAGE_COUNT_AFTER (removed: $((IMAGE_COUNT_BEFORE - IMAGE_COUNT_AFTER)))"
              echo "Snapshots: $SNAPSHOT_COUNT_AFTER (removed: $((SNAPSHOT_COUNT_BEFORE - SNAPSHOT_COUNT_AFTER)))"

              # Calculate space savings
              OVERLAYFS_SIZE=$(du -sb /host/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs 2>/dev/null | awk '{print $1}' || echo "0")
              OVERLAYFS_SIZE_GB=$((OVERLAYFS_SIZE / 1024 / 1024 / 1024))
              echo "Current overlayfs size: ${OVERLAYFS_SIZE_GB} GB"

              echo "=== Pruning complete on $(hostname) at $(date) ==="
            securityContext:
              privileged: true
            volumeMounts:
            - name: containerd-sock
              mountPath: /host/run/containerd
            - name: snapshots
              mountPath: /host/var/lib/containerd
              readOnly: true
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 256Mi
          tolerations:
          - operator: Exists
          volumes:
          - name: containerd-sock
            hostPath:
              path: /run/containerd
              type: Directory
          - name: snapshots
            hostPath:
              path: /var/lib/containerd
              type: Directory
---
# Manual Job to run the cleanup immediately (for testing)
apiVersion: batch/v1
kind: Job
metadata:
  name: containerd-image-prune-manual
  namespace: kube-system
  annotations:
    argocd.argoproj.io/hook: Skip # Don't sync this with ArgoCD
    flux.weave.works/ignore: "true" # Don't sync this with Flux
spec:
  ttlSecondsAfterFinished: 300 # Clean up 5 minutes after completion
  template:
    metadata:
      labels:
        app: containerd-image-prune
    spec:
      hostNetwork: true
      hostPID: true
      restartPolicy: Never
      containers:
      - name: prune
        image: debian:bookworm-slim@sha256:b4aa902587c2e61ce789849cb54c332b0400fe27b1ee33af4669e1f7e7c3e22f
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Starting MANUAL containerd image pruning on $(hostname) at $(date) ==="

          # Install required tools
          apt-get update -qq
          apt-get install -y -qq wget tar procps

          # Download and install crictl
          CRICTL_VERSION="v1.31.1"
          wget -q https://github.com/kubernetes-sigs/cri-tools/releases/download/${CRICTL_VERSION}/crictl-${CRICTL_VERSION}-linux-amd64.tar.gz -O /tmp/crictl.tar.gz
          tar -xzf /tmp/crictl.tar.gz -C /usr/local/bin/
          chmod +x /usr/local/bin/crictl
          rm /tmp/crictl.tar.gz

          # Configure containerd socket
          export CONTAINER_RUNTIME_ENDPOINT=unix:///host/run/containerd/containerd.sock
          export IMAGE_SERVICE_ENDPOINT=unix:///host/run/containerd/containerd.sock

          # Get baseline metrics
          echo "=== Before pruning ==="
          IMAGE_COUNT_BEFORE=$(crictl images -q | wc -l)
          SNAPSHOT_COUNT_BEFORE=$(ls /host/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots 2>/dev/null | wc -l || echo "0")
          echo "Images: $IMAGE_COUNT_BEFORE"
          echo "Snapshots: $SNAPSHOT_COUNT_BEFORE"

          # Prune unused images
          echo "=== Pruning unused images ==="
          crictl rmi --prune 2>&1 || echo "Prune completed with warnings (expected for in-use images)"

          # Get post-prune metrics
          echo "=== After pruning ==="
          IMAGE_COUNT_AFTER=$(crictl images -q | wc -l)
          SNAPSHOT_COUNT_AFTER=$(ls /host/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots 2>/dev/null | wc -l || echo "0")
          echo "Images: $IMAGE_COUNT_AFTER (removed: $((IMAGE_COUNT_BEFORE - IMAGE_COUNT_AFTER)))"
          echo "Snapshots: $SNAPSHOT_COUNT_AFTER (removed: $((SNAPSHOT_COUNT_BEFORE - SNAPSHOT_COUNT_AFTER)))"

          # Calculate space savings
          OVERLAYFS_SIZE=$(du -sb /host/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs 2>/dev/null | awk '{print $1}' || echo "0")
          OVERLAYFS_SIZE_GB=$((OVERLAYFS_SIZE / 1024 / 1024 / 1024))
          echo "Current overlayfs size: ${OVERLAYFS_SIZE_GB} GB"

          echo "=== Pruning complete on $(hostname) at $(date) ==="
        securityContext:
          privileged: true
        volumeMounts:
        - name: containerd-sock
          mountPath: /host/run/containerd
        - name: snapshots
          mountPath: /host/var/lib/containerd
          readOnly: true
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
      tolerations:
      - operator: Exists
      volumes:
      - name: containerd-sock
        hostPath:
          path: /run/containerd
          type: Directory
      - name: snapshots
        hostPath:
          path: /var/lib/containerd
          type: Directory
