---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ${APP}-secret
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  refreshPolicy: Periodic
  refreshInterval: "15m"
  target:
    name: ${APP}-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      metadata:
        labels:
          cnpg.io/reload: "true"
        annotations:
          reloader.stakater.com/auto: "true"
      templateFrom:
      - target: Data
        configMap:
          name: ${APP}-config
          items:
          - key: config.yaml
            templateAs: Values

auth:
  openid:
    enabled: true
    redirecturl: "https://${APP}.${ROOT_DOMAIN}/auth/openid/"
    providers:
      - name: authentik
        authurl: "${OIDC_ISSUER}/application/o/vikunja"
        logouturl: "${OIDC_ISSUER}/application/o/vikunja/end-session/"
        clientid: "" # copy from Authetik
        clientsecret: "" # copy from Authentik



        # If set to true, enables a /metrics endpoint for prometheus to collect metrics about Vikunja. Default: false
        VIKUNJA_METRICS_ENABLED: "false"
        # If set to a non-empty value the /metrics endpoint will require this as a username via basic auth. Default: ""
        VIKUNJA_METRICS_USERNAME: ""
        # If set to a non-empty value the /metrics endpoint will require this as a password via basic auth. Default: ""
        VIKUNJA_METRICS_PASSWORD: ""
        # The avatar source for the user. Can be gravatar, initials, upload or marble. Default: initials
        VIKUNJA_DEFAULTSETTINGS_AVATAR_PROVIDER: "initials"
        # The id of the file used as avatar. Default: 0
        VIKUNJA_DEFAULTSETTINGS_AVATAR_FILE_ID: "0"
        # If set to true users will get task reminders via email. Default: false
        VIKUNJA_DEFAULTSETTINGS_EMAIL_REMINDERS_ENABLED: "false"
        # If set to true will allow other users to find this user when searching for parts of their name. Default: false
        VIKUNJA_DEFAULTSETTINGS_DISCOVERABLE_BY_NAME: "false"
        # If set to true will allow other users to find this user when searching for their exact email. Default: false
        VIKUNJA_DEFAULTSETTINGS_DISCOVERABLE_BY_EMAIL: "false"
        # If set to true will send an email every day with all overdue tasks at a configured time. Default: true
        VIKUNJA_DEFAULTSETTINGS_OVERDUE_TASKS_REMINDERS_ENABLED: "true"
        # When to send the overdue task reminder email. Default: 9:00
        VIKUNJA_DEFAULTSETTINGS_OVERDUE_TASKS_REMINDERS_TIME: "9:00"
        # The id of the default project. Default: 0
        VIKUNJA_DEFAULTSETTINGS_DEFAULT_PROJECT_ID: "0"
        # Start of the week for the user. 0 is sunday, 1 is monday and so on. Default: 0
        VIKUNJA_DEFAULTSETTINGS_WEEK_START: "0"
        # The language of the user interface. Default: ""
        VIKUNJA_DEFAULTSETTINGS_LANGUAGE: ""
        # The time zone of each individual user. Default: <time zone set at service.timezone>
        VIKUNJA_DEFAULTSETTINGS_TIMEZONE: ""
        # Whether to enable support for webhooks. Default: true
        VIKUNJA_WEBHOOKS_ENABLED: "true"
        # The timeout in seconds until a webhook request fails when no response has been received. Default: 30
        VIKUNJA_WEBHOOKS_TIMEOUTSECONDS: "30"
        # The URL of a mole instance to use to proxy outgoing webhook requests. Default: ""
        VIKUNJA_WEBHOOKS_PROXYURL: ""
        # The proxy password to use when authenticating against the proxy. Default: ""
        VIKUNJA_WEBHOOKS_PROXYPASSWORD: ""
        # If set to true, Vikunja will automatically request a TLS certificate from Let's Encrypt. Default: false
        VIKUNJA_AUTOTLS_ENABLED: "false"
        # A valid email address which will be used to register certificates with Let's Encrypt. Default: ""
        VIKUNJA_AUTOTLS_EMAIL: ""
        # A duration when certificates should be renewed before they expire. Default: 30d
        VIKUNJA_AUTOTLS_RENEWBEFORE: "30d"

  dataFrom:
    - extract:
        key: 'Vikunja Database User'
        conversionStrategy: Unicode
      rewrite:
        - regexp:
            source: "(.*)"
            target: "user_$1"
    - extract:
        key: 'Vikunja OIDC Credentials'
        conversionStrategy: Unicode
      rewrite:
        - regexp:
            source: "(.*)"
            target: "oidc_$1"
    - sourceRef:
        storeRef:
          kind: SecretStore
          name: this
      extract:
        key: ${APP}-postgres-user
      rewrite:
        - regexp:
            source: "(.*)"
            target: "postgres_$1"


