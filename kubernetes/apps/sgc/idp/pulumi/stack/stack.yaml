---
# yaml-language-server: $schema=https://schemas.budimanjojo.com/pulumi.com/stack_v1.json
apiVersion: pulumi.com/v1
kind: Stack
metadata:
  name: ${APP}
spec:
  serviceAccountName: ${APP}
  fluxSource:
    sourceRef:
      apiVersion: source.toolkit.fluxcd.io/v1
      kind: GitRepository
      name: flux-system
    dir: kubernetes/apps/sgc/idp/pulumi
  stack: ${APP}
  # resyncFrequencySeconds: 300
  backend: postgres://postgres-rw.database.svc.cluster.local
  # refresh: true
  # continueResyncOnCommitMatch: true
  # destroyOnFinalize: true
  # workspaceReclaimPolicy: Delete
  envRefs:
    HOME:
      type: Literal
      literal:
        value: /tmp/.pulumi
    PULUMI_HOME:
      type: Literal
      literal:
        value: /tmp/.pulumi
    USER:
      type: Literal
      literal:
        value: pulumi
    GITHUB_TOKEN:
      type: Secret
      secret:
        name: pulumi-operator-github
        key: credential
    PGUSER:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: username
    PGPASSWORD:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: password
    PGHOST:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: hostname
    PGPORT:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: port
    PGDATABASE:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: database
  secretsRef:
    github:token:
      type: Secret
      secret:
        name: pulumi-operator-github
        key: credential
    app:cluster_sgc:
      type: Secret
      secret:
        name: ${APP}-${CLUSTER_CNAME}-kubeconfig
        key: kubeconfig.json
    app:cluster_equestria:
      type: Secret
      secret:
        name: ${APP}-equestria-kubeconfig
        key: kubeconfig.json
    authentik:token:
      type: Secret
      secret:
        name: authentik-secret
        key: token
    authentik:url:
      type: Secret
      secret:
        name: authentik-secret
        key: url
  workspaceTemplate:
    spec:
      image: daviddriscoll/pulumi:latest
      pulumiLogLevel: 11

