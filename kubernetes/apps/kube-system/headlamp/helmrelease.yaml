---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrepository-source-v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: headlamp
  namespace: kube-system # Required for Renovate lookups
spec:
  interval: 1h
  url: https://kubernetes-sigs.github.io/headlamp
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app headlamp
  namespace: &namespace kube-system
  annotations:
    # renovate: datasource=helm depName=headlamp registryUrl=https://kubernetes-sigs.github.io/headlamp
    renovate.flux.cluster.local/chart: headlamp
spec:
  chart:
    spec:
      chart: headlamp
      version: 0.40.0
      sourceRef:
        kind: HelmRepository
        name: *app
        namespace: *namespace
  maxHistory: 3
  interval: 1h
  timeout: 10m
  install:
    createNamespace: true
    replace: true
    remediation:
      retries: 7
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 7
      strategy: rollback
  rollback:
    force: false
    cleanupOnFail: true
    recreate: true
  uninstall:
    keepHistory: false
  values:
    replicaCount: 2
    podAnnotations:
      reloader.stakater.com/auto: "true"
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 1000
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
    volumeMounts:
      - name: config
        mountPath: /home/headlamp/.config
      - name: tmp
        mountPath: /tmp
    volumes:
      - name: config
        emptyDir: {}
      - name: tmp
        emptyDir: {}
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
    autoscaling:
      enabled: false
    config:
      watchPlugins: true
      oidc:
        externalSecret:
          enabled: true
          name: headlamp-oidc
    pluginsManager:
      enabled: true
      baseImage: node:lts-alpine
      version: latest
      configContent: |
        plugins:
          - name: headlamp_cert-manager
            source: https://artifacthub.io/packages/headlamp/headlamp-plugins/headlamp_cert-manager
            version: 0.1.0
          - name: external-secrets-operator
            source: https://artifacthub.io/packages/headlamp/external-secrets-operator-headlamp-plugin/external-secrets-operator
            version: 0.1.0-beta7
          - name: headlamp_flux
            source: https://artifacthub.io/packages/headlamp/headlamp-plugins/headlamp_flux
            version: 0.5.0
          - name: prometheus_headlamp_plugin
            source: https://artifacthub.io/packages/headlamp/test-123/prometheus_headlamp_plugin
            version: 0.0.3
        installOptions:
          parallel: true
          maxConcurrent: 2
