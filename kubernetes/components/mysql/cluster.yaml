---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/refs/heads/main/mysql.oracle.com/innodbcluster_v2.json
apiVersion: mysql.oracle.com/v2
kind: InnoDBCluster
metadata:
  name: &app ${APP}-mysql
spec:
  instances: 2
  tlsUseSelfSigned: true
  router:
    instances: 1
    podSpec:
      resources:
        requests:
          cpu: 48m
          memory: 64M
  secretName: ${APP}-mysql-secret
  initDB:
    dump:
      name: ${APP}-mysql-initdb
      storage:
        s3:
          bucketName: ${APP}
          prefix: mysql/dump/
          config: ${APP}-garage-access-key
          profile: default
          endpoint: https://s3.${CLUSTER_DOMAIN}
  backupProfiles:
    - name: dump
      dumpInstance:
        storage:
          s3:
            bucketName: ${APP}
            prefix: mysql/dump/
            config: ${APP}-garage-access-key
            profile: default
            endpoint: https://s3.${CLUSTER_DOMAIN}
    - name: snapshot
      snapshot:
        storage:
          s3:
            bucketName: ${APP}
            prefix: mysql/snapshot/
            config: ${APP}-garage-access-key
            profile: default
            endpoint: https://s3.${CLUSTER_DOMAIN}
  backupSchedules:
    - name: snapshot
      schedule: "${MYSQL_BACKUP_SCHEDULE:-0 4 * * *}" # Daily at 4 AM
      backupProfileName: snapshot
      timeZone: ${TIMEZONE}
    - name: dump
      schedule: "${MYSQL_DUMP_SCHEDULE:-0 5 * * *}" # Daily at 5 AM
      backupProfileName: dump
      timeZone: ${TIMEZONE}
  datadirVolumeClaimTemplate:
    storageClass: ${MYSQL_STORAGE_CLASS:=longhorn}
    accessMode: ${MYSQL_ACCESS_MODE:=ReadWriteOnce}
    size: ${MYSQL_STORAGE:=10Gi}

  podSpec:
    resources:
      requests:
        cpu: 50m
        memory: "${MYSQL_MIN_MEMORY_IN_MB:=256}Mi"
      limits:
        cpu: 1
        memory: "${MYSQL_MAX_MEMORY_IN_MB:=1024}Mi"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            podAffinityTerm:
              topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: *app
                  app.kubernetes.io/component: *app
