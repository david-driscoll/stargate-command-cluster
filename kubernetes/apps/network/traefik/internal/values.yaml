---
# yaml-language-server: $schema=https://raw.githubusercontent.com/traefik/traefik-helm-chart/refs/heads/master/traefik/values.schema.json
image:
  registry: ghcr.io
  repository: traefik/traefik
  tag: v3.5.3@sha256:84eb6c0e67c99fa026bf1bf4b0afd9ad44350d375b4ebc5049c5f70543a729d6
fullnameOverride: traefik-internal
deployment:
  kind: Deployment
  replicas: 2
service:
  annotations:
    reloader.stakater.com/auto: "true"
    external-dns.alpha.kubernetes.io/target: "${INTERNAL_DOMAIN}"
    io.cilium/lb-ipam-ips: "${INTERNAL_IP}"
  externalIPs:
    - "${INTERNAL_IP}"
additionalArguments:
  - '--providers.file.filename=/config/store.yaml'
  - '--serversTransport.insecureSkipVerify=true'
  - --certificatesresolvers.tailscale.tailscale=true
  - --entryPoints.web.address=:80/tcp
  - --entryPoints.websecure.address=:443/tcp
  - --entryPoints.postgres.address=:5432/tcp
  - --entryPoints.mariadb.address=:3306/tcp
volumes:
  # - name: le-staging-tls
  - name: le-production-tls
    mountPath: '/certs'
    type: secret
  - name: cluster-tls
    mountPath: '/cluster-certs'
    type: secret
  - name: traefik-tls-settings
    mountPath: '/config'
    type: configMap
ports:
  traefik:
    expose:
      default: true
  web:
    port: 80
    exposedPort: 80
    redirections:
      entryPoint:
        to: websecure
        scheme: https
        permanent: true
  websecure:
    port: 443
    exposedPort: 443
    tls:
      enabled: true
  postgres:
    expose:
      default: true
    port: 5432
    exposedPort: 5432
    protocol: TCP
  mariadb:
    expose:
      default: true
    port: 3306
    exposedPort: 3306
    protocol: TCP
ingressClass:
  enabled: true
  isDefaultClass: false
  name: internal
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespaceSelector:
      any: true
resources:
  requests:
    cpu: 50m
    memory: 100Mi
  limits:
    cpu: 150m
    memory: 200Mi
providers:
  kubernetesCRD:
    ingressClass: "internal"
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true
  kubernetesIngress:
    ingressClass: "internal"
    enabled: true
    allowExternalNameServices: true
  kubernetesGateway:
    enabled: true
    experimentalChannel: true
    statusAddress:
      ip: "${INTERNAL_IP}"
logs:
  access:
    enabled: true
  general:
    # -- Set [logs format](https://doc.traefik.io/traefik/observability/logs/#format)
    format: common
    # -- Alternative logging levels are TRACE, DEBUG, INFO, WARN, ERROR, FATAL, and PANIC.
    level: "INFO"
ingressRoute:
  dashboard:
    enabled: true
    annotations:
      external-dns.alpha.kubernetes.io/target: "${INTERNAL_DOMAIN}"
      external-dns.alpha.kubernetes.io/hostname: internal.${CLUSTER_DOMAIN}
    matchRule: Host(`internal.${CLUSTER_DOMAIN}`)
    services:
      - name: api@internal
        kind: TraefikService
    entryPoints:
      - "traefik"
      - "websecure"
    middlewares:
      - name: authenticated-user
        namespace: network
    tls:
      secretName: "le-production-tls"
experimental:
  plugins:
    traefik-plugin-query-modification:
      moduleName: "github.com/kingjan1999/traefik-plugin-query-modification"
      version: "v1.0.0"
  fastProxy:
    enabled: true
  otlpLogs: true
web:
  forwardedHeaders:
    insecure: true
  proxyProtocol:
    insecure: true
websecure:
  forwardedHeaders:
    insecure: true
  proxyProtocol:
    insecure: true

tlsStore:
  default:
    certificates:
      - secretName: &default-certificate le-production-tls
    defaultCertificate:
      secretName: *default-certificate
gatewayClass:
  enabled: true
gateway:
  enabled: true
  annotations:
    external-dns.alpha.kubernetes.io/target: &hostname "${INTERNAL_DOMAIN}"
  infrastructure:
    annotations:
        external-dns.alpha.kubernetes.io/hostname: *hostname
  name: internal
  listeners:
    web:
      port: 80
      protocol: HTTP
      namespacePolicy:
        from: All

    websecure:
      port: 443
      protocol: HTTPS
      namespacePolicy:
        from: All
      mode: Terminate
      certificateRefs:
        - name: le-production-tls
          kind: Secret

    postgres:
      protocol: TCP
      port: 5432
      namespacePolicy:
        from: All

    mariadb:
      protocol: TCP
      port: 3306
      namespacePolicy:
        from: All
