---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ${APP}-config
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  refreshPolicy: Periodic
  refreshInterval: 4m
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: ${APP}-config
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      metadata:
        labels:
          cnpg.io/reload: "true"
        annotations:
          reloader.stakater.com/auto: "true"
      data:
        configuration.yaml: |
          ---
          theme: auto
          
          server:
            address: 'tcp://0.0.0.0:9091/authelia'
            buffers:
              read: 8192
              write: 8192
            timeouts:
              read: 6s
              write: 6s
              idle: 30s
          
          log:
            level: info
            format: json
          
          telemetry:
            metrics:
              enabled: true
              address: 'tcp://0.0.0.0:9959/metrics'
          
          identity_validation:
            reset_password:
              jwt_secret: {{ .jwt_secret }}
          
          session:
            name: authelia_session
            secret: {{ .session_secret }}
            expiration: 1h
            inactivity: 5m
            remember_me: 1M
            
            cookies:
              - domain: {{ .root_domain }}
                authelia_url: https://authelia.{{ .root_domain }}
                default_redirection_url: https://{{ .root_domain }}
            
            redis:
              host: valkey.database.svc.cluster.local
              port: 6379
              database_index: 6
          
          regulation:
            max_retries: 5
            find_time: 2m
            ban_time: 5m
          
          storage:
            encryption_key: {{ .storage_encryption_key }}
            postgres:
              address: 'tcp://{{ .postgres_host }}:{{ .postgres_port }}'
              database: {{ .postgres_database }}
              username: {{ .postgres_username }}
              password: {{ .postgres_password }}
              timeout: 5s
          
          notifier:
            disable_startup_check: false
            smtp:
              address: 'submissions://{{ .smtp_host }}:{{ .smtp_port }}'
              username: {{ .smtp_username }}
              password: {{ .smtp_password }}
              sender: "Authelia <{{ .smtp_from }}>"
              subject: "[Authelia] {title}"
              startup_check_address: {{ .smtp_startup_check }}
              disable_require_tls: false
              disable_html_emails: false
              tls:
                server_name: {{ .smtp_host }}
                skip_verify: false
          
          authentication_backend:
            password_reset:
              disable: false
            refresh_interval: 5m
            
            ldap:
              address: 'ldap://lldap.database.svc.cluster.local:3890'
              implementation: custom
              timeout: 5s
              start_tls: false
              base_dn: dc=home,dc=arpa
              username_attribute: uid
              additional_users_dn: ou=people
              users_filter: (&({username_attribute}={input})(objectClass=person))
              additional_groups_dn: ou=groups
              groups_filter: (member={dn})
              group_name_attribute: cn
              mail_attribute: mail
              display_name_attribute: displayName
              user: uid=admin,ou=people,dc=home,dc=arpa
              password: {{ .ldap_password }}
          
          access_control:
            default_policy: deny
            rules:
              - domain:
                  - "authelia.{{ .root_domain }}"
                  - "auth.{{ .root_domain }}"
                policy: bypass
              
              - domain: "*.{{ .root_domain }}"
                policy: one_factor
                subject:
                  - ["group:admins"]
                  - ["group:users"]
          
          identity_providers:
            oidc:
              hmac_secret: {{ .oidc_hmac_secret }}
              jwks:
                - key_id: 'authelia-rsa'
                  algorithm: 'RS256'
                  use: 'sig'
                  key: {{ .oidc_jwks_key | toJson }}
              
              access_token_lifespan: 1h
              authorize_code_lifespan: 1m
              id_token_lifespan: 1h
              refresh_token_lifespan: 90m
              
              enable_client_debug_messages: false
              enforce_pkce: public_clients_only
              
              cors:
                endpoints:
                  - authorization
                  - token
                  - revocation
                  - introspection
                  - userinfo
                allowed_origins_from_client_redirect_uris: true
              
              clients:
                {{- range .oidc_clients }}
                - client_id: {{ .client_id }}
                  client_name: {{ .client_name }}
                  client_secret: {{ .client_secret }}
                  public: {{ .public | default false }}
                  authorization_policy: {{ .authorization_policy | default "one_factor" }}
                  redirect_uris: {{ .redirect_uris | toJson }}
                  scopes:
                    - openid
                    - profile
                    - email
                    - groups
                  {{- if .grant_types }}
                  grant_types: {{ .grant_types | toJson }}
                  {{- end }}
                  {{- if .response_types }}
                  response_types: {{ .response_types | toJson }}
                  {{- end }}
                  {{- if .response_modes }}
                  response_modes: {{ .response_modes | toJson }}
                  {{- end }}
                  userinfo_signed_response_alg: none
                  token_endpoint_auth_method: {{ .token_endpoint_auth_method | default "client_secret_basic" }}
                {{- end }}
  dataFrom:
    - extract:
        key: 'Authelia Config'
    - extract:
        key: 'LLDAP Admin'
      rewrite:
        - regexp:
            source: "password"
            target: "ldap_password"
    - extract:
        key: "${APP}-postgres"
      rewrite:
        - regexp:
            source: "hostname"
            target: "postgres_host"
        - regexp:
            source: "port"
            target: "postgres_port"
        - regexp:
            source: "database"
            target: "postgres_database"
        - regexp:
            source: "username"
            target: "postgres_username"
        - regexp:
            source: "password"
            target: "postgres_password"
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ${APP}-postgres
spec:
  refreshPolicy: Periodic
  refreshInterval: 4m
  secretStoreRef:
    kind: ClusterSecretStore
    name: database
  target:
    name: ${APP}-postgres
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      metadata:
        labels:
          cnpg.io/reload: "true"
        annotations:
          reloader.stakater.com/auto: "true"
  dataFrom:
    - extract:
        key: "${APP}-postgres"
