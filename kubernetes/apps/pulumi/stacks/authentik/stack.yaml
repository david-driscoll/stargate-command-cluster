---
# yaml-language-server: $schema=https://schemas.budimanjojo.com/pulumi.com/stack_v1.json
apiVersion: pulumi.com/v1
kind: Stack
metadata:
  name: ${APP}
spec:
  fluxSource:
    sourceRef:
      apiVersion: source.toolkit.fluxcd.io/v1
      kind: GitRepository
      name: home-operations
    dir: stacks/authentik
  serviceAccountName: ${APP}
  stack: authentik
  resyncFrequencySeconds: 90
  backend: postgres://postgres-rw.database.svc.cluster.local
  continueResyncOnCommitMatch: false
  destroyOnFinalize: false
  workspaceReclaimPolicy: Retain
  # refresh: true
  # prerequisites:
  #   - name: home-operations
  envRefs:
    # Pulumi CLI verbose logging - enables debug output
    PULUMI_DEBUG_COMMANDS:
      type: Literal
      literal:
        value: "true"
    # Pulumi log to stderr (used by automation API)
    PULUMI_LOG_TO_STDERR:
      type: Literal
      literal:
        value: "true"
    # gRPC logging verbosity (valid values: info, warning, error)
    GRPC_GO_LOG_SEVERITY_LEVEL:
      type: Literal
      literal:
        value: "info"
    GRPC_GO_LOG_VERBOSITY_LEVEL:
      type: Literal
      literal:
        value: "99"
    GITHUB_TOKEN:
      type: Secret
      secret:
        name: pulumi-operator-github
        key: credential
    CONNECT_HOST:
      type: Literal
      literal:
        value: "http://onepassword-connect.kube-system.svc.cluster.local:8080"
    CONNECT_VAULT:
      type: Literal
      literal:
        value: "Eris"
    CONNECT_TOKEN:
      type: Secret
      secret:
        name: pulumi-operator-connect-token
        key: credential
    PULUMI_CONFIG_PASSPHRASE:
      type: Secret
      secret:
        name: pulumi-operator-passphrase
        key: password
    PGUSER:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: username
    PGPASSWORD:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: password
    PGHOST:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: hostname
    PGPORT:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: port
    PGDATABASE:
      type: Secret
      secret:
        name: pulumi-operator-postgres
        key: database
    # HOME:
    #   type: Literal
    #   literal:
    #     value: /tmp/.pulumi
    # PULUMI_HOME:
    #   type: Literal
    #   literal:
    #     value: /tmp/.pulumi
    # USER:
    #   type: Literal
    #   literal:
    #     value: pulumi
  secretsRef:
    github:token:
      type: Secret
      secret:
        name: pulumi-operator-github
        key: credential
    authentik:token:
      type: Secret
      secret:
        name: authentik-secret
        key: credential
    authentik:url:
      type: Secret
      secret:
        name: authentik-secret
        key: url
  workspaceTemplate:
    spec:
      # renovate: datasource=docker depName=pulumi/pulumi-nodejs
      image: pulumi/pulumi-nodejs:3.202.0
      resources:
        requests:
          cpu: 500m
          memory: 256Mi
        limits:
          cpu: 2
          memory: 2Gi
      pulumiLogLevel: 11
